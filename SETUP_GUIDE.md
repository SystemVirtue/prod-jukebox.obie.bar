# Multi-User YouTube Music Player - Setup Guide

## Architecture Overview

This application is a scalable multi-user YouTube music video player built with:
- **Frontend**: Vite, TypeScript, React, shadcn-ui, Tailwind CSS
- **Backend**: Supabase (Auth, Postgres, Realtime)
- **PWA**: Progressive Web App capabilities for desktop-like experience

## Features

1. **User Authentication**: Sign up/login via Supabase Auth
2. **Device Approval System**: Players must be approved before playback
3. **Private Playlists**: Each user has their own playlist stored in Supabase
4. **Real-time Admin Controls**: Control playback remotely via Supabase Realtime
5. **Room Sharing**: Create public rooms for friends to join and control together
6. **PWA Support**: Installable web app with offline capabilities

## Database Schema

### Tables

#### `playlists`
- `id` (UUID, primary key)
- `user_id` (UUID, foreign key to auth.users)
- `video_id` (TEXT) - YouTube video ID
- `title` (TEXT) - Video title
- `artist` (TEXT) - Artist/channel name
- `position` (INTEGER) - Order in playlist
- `room_id` (UUID, nullable) - For shared rooms
- `created_at` (TIMESTAMPTZ)

#### `approved_devices`
- `id` (UUID, primary key)
- `device_id` (TEXT, unique) - Generated by crypto.randomUUID()
- `user_id` (UUID, foreign key to auth.users)
- `device_name` (TEXT, nullable)
- `approved_at` (TIMESTAMPTZ)

#### `rooms`
- `id` (UUID, primary key)
- `owner_id` (UUID, foreign key to auth.users)
- `name` (TEXT)
- `is_public` (BOOLEAN)
- `created_at` (TIMESTAMPTZ)

## Setup Instructions

### 1. Supabase Setup

1. Create a new Supabase project at https://supabase.com
2. Go to Project Settings â†’ API
3. Copy your project URL and anon/public key
4. Update `.env` file:
   ```
   VITE_SUPABASE_URL=your-project-url
   VITE_SUPABASE_ANON_KEY=your-anon-key
   ```

### 2. Database Migration

Run the SQL migration in Supabase SQL Editor:
```sql
-- See supabase/migrations/20250000000000_create_multi_user_tables.sql
```

This creates:
- All necessary tables
- Row Level Security (RLS) policies
- Indexes for performance

### 3. Install Dependencies

```bash
npm install
```

### 4. Run Development Server

```bash
npm run dev
```

## Application Routes

- `/` - Main jukebox interface (existing functionality)
- `/auth` - Sign up / Sign in page
- `/player` - Player page with device validation
- `/admin` - Admin control panel (mobile-friendly)
- `/room/:roomId` - Shared room for collaborative control

## User Flow

### First Time Setup

1. User navigates to `/auth` and creates an account
2. User goes to `/player` on their player device
3. Player generates a unique `player_device_id` (stored in localStorage)
4. Player displays large device ID and waits for approval
5. User opens `/admin` on their phone/tablet
6. User enters the device ID in the approval form
7. Device is approved, player starts playback

### Normal Usage

1. User signs in at `/auth`
2. Player at `/player` auto-validates device and starts playing
3. Admin at `/admin` can:
   - Play/Pause/Next controls
   - Adjust volume
   - Reorder playlist
   - Add/remove songs
4. All commands sent via Supabase Realtime channels

### Room Sharing

1. User creates a room in admin panel
2. Room gets a unique ID
3. User shares room link `/room/:roomId` with friends
4. Friends can join and control the same playlist
5. Real-time sync via Supabase Realtime subscriptions

## Security (RLS Policies)

All database operations are protected by Row Level Security:

- Users can only view/modify their own playlists
- Users can only approve devices for their own account
- Room owners control room settings
- Public rooms are viewable by anyone but controlled by members

## Real-time Communication

### Player Control Channel
```typescript
Channel: `user:${userId}`
Event: 'player_control'
Payload: { action: 'play|pause|next', videoId?: string, volume?: number }
```

### Room Control Channel
```typescript
Channel: `room:${roomId}`
Event: 'room_control'
Payload: { action: string, userId: string }
```

## Deployment

### Vercel Deployment

1. Push code to GitHub
2. Import project in Vercel
3. Add environment variables:
   - `VITE_SUPABASE_URL`
   - `VITE_SUPABASE_ANON_KEY`
4. Deploy

### PWA Installation

Once deployed, users can install the app:
- **Desktop**: Click install icon in browser address bar
- **Mobile**: "Add to Home Screen" from browser menu

## API Endpoints (Supabase Auto-generated)

- `POST /auth/v1/signup` - User registration
- `POST /auth/v1/token?grant_type=password` - User login
- `GET /rest/v1/playlists` - Fetch playlist
- `POST /rest/v1/playlists` - Add to playlist
- `PATCH /rest/v1/playlists?id=eq.{id}` - Update playlist item
- `DELETE /rest/v1/playlists?id=eq.{id}` - Remove from playlist
- `GET /rest/v1/approved_devices` - Check device approval
- `POST /rest/v1/approved_devices` - Approve device

## Development Notes

- Device ID is generated once per browser/device using `crypto.randomUUID()`
- Player page uses YouTube IFrame API for video playback
- Admin panel is mobile-optimized with touch-friendly controls
- Real-time subscriptions auto-reconnect on network changes
- PWA caches assets for offline functionality

## Troubleshooting

### Player not starting
1. Check device is approved in admin panel
2. Verify user is signed in
3. Check browser console for errors

### Real-time commands not working
1. Verify Supabase Realtime is enabled in project settings
2. Check network tab for websocket connections
3. Ensure user IDs match between admin and player

### Database errors
1. Verify RLS policies are active
2. Check user is authenticated
3. Review Supabase logs in dashboard

## Next Steps

- Add YouTube search integration in admin panel
- Implement queue management with drag-and-drop
- Add playlist import/export
- Create room invitation system
- Add analytics and play history
